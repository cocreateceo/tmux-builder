# Session Notes - January 29, 2026

## Summary

Completed major bug fixes for the client dashboard UI. Fixed critical infinite loop issues in React hooks, WebSocket reconnect loops, and chat history display problems.

## What Was Accomplished

### Bug Fixes
1. **Infinite API Loop (1775+ requests)** - Fixed in `useClientSession.js`
   - Cause: `client` in useCallback dependency array while `setClient` was called inside
   - Fix: Removed `client` from deps, used refs for stable URL params

2. **WebSocket Reconnect Loop (code 1011)** - Fixed in `useProgressSocket.js`
   - Cause: Reconnecting on server errors for invalid sessions
   - Fix: Added `noReconnectCodes = [1000, 1008, 1011]`

3. **"Loading your projects..." Stuck Forever** - Fixed in `useClientSession.js`
   - Cause: Complex useEffect with multiple conditions preventing state updates
   - Fix: Simplified to single useEffect with empty deps, `loading` starts as `true`

4. **Missing AI Response in Chat** - Fixed in `backend/main.py`
   - Cause: `summary.md` content not persisted to `chat_history.jsonl`
   - Fix: Enhanced `/api/history` endpoint to recover from `summary.md` if last AI message missing

### New Features
1. **Client Onboarding Page** (`/client_input` route)
   - Created `ClientOnboarding.jsx` with form matching API spec
   - Fields: name, email, phone, initial_request
   - Posts to `/api/admin/sessions`, redirects to `/client?guid=xxx` on success

2. **Routing Updates** (`App.jsx`)
   - `/client_input` and `/onboard` → ClientOnboarding
   - `/client` → ClientApp
   - `/` → SplitChatView (admin)

## Files Modified This Session

### Modified Files
- `CLAUDE.md` - Updated with client UI docs, new gotchas, fixed port numbers
- `README.md` - Updated project documentation
- `README_FINAL.md` - Updated final documentation
- `backend/main.py` - Chat history recovery from summary.md, timezone import fix
- `frontend/src/App.jsx` - Added routing for /client_input, /onboard, /client paths
- `frontend/src/client/ClientApp.jsx` - Simplified chat history loading, fixed loading state
- `frontend/src/client/components/NewProjectModal.jsx` - Added client prop, error handling
- `frontend/src/client/hooks/useClientSession.js` - Complete rewrite to fix infinite loop
- `frontend/src/client/index.js` - Updated exports
- `frontend/src/hooks/useProgressSocket.js` - WebSocket no-reconnect codes fix

### New Files Created
- `frontend/src/client/ClientOnboarding.jsx` - Client onboarding form (/client_input)
- `docs/SESSION_NOTES_2026-01-29.md` - This session notes file

### Git Status
- Branch: `wsocket_ui` (13 commits ahead of origin)
- All changes uncommitted - ready for review and commit

## Known Issues / Pending

### CRITICAL: Activity Panel Not Receiving Updates
- **Symptom:** Activity panel stays empty even when Claude is working
- **Root Cause:** Old uvicorn process holding port 8082, new ws_server code not running
- **Fix Required:**
  ```bash
  # Kill all backend processes
  pkill -f uvicorn
  pkill -f "python.*main.py"
  lsof -i :8080  # Verify clear
  lsof -i :8082  # Verify clear

  # Restart fresh
  cd backend && uvicorn main:app --host 0.0.0.0 --port 8080 --reload
  ```

### Activity Log Persistence
- `activity_log.jsonl` should be created by ws_server when receiving notify.sh messages
- Verify ws_server.py writes to activity_log.jsonl on status/progress messages
- ActivityPanel should load historical data on mount

## Architecture Reminder

```
User → ChatPanel → clientApi.sendMessage → /api/chat → tmux → Claude CLI
                                                              ↓
UI ← ActivityPanel ← useProgressSocket ← ws_server:8082 ← notify.sh
```

**notify.sh location:** `sessions/active/<guid>/notify.sh`
- Generated by `session_initializer.py` from `notify_template.sh`
- Sends messages to `ws://localhost:8082/ws/<guid>`

## Testing Checklist for Next Session

1. [ ] Kill all backend processes, restart fresh
2. [ ] Verify port 8082 is bound by new ws_server
3. [ ] Test `/client_input` → creates session → redirects to `/client?guid=xxx`
4. [ ] Test chat sends message, receives response
5. [ ] Test Activity panel shows real-time status updates
6. [ ] Test `activity_log.jsonl` is created and persisted
7. [ ] Test page refresh loads chat history AND activity history

## Session 2 (Later Jan 29)

### Issues Fixed

5. **WebSocket Path API Compatibility** - Fixed in `backend/ws_server.py`
   - **Symptom:** Server error 1011 when notify.sh sent messages
   - **Root Cause:** Code used `websocket.request.path` (v16+ API) but system has websockets v12
   - **Fix:** Updated to use `getattr(websocket, 'path', None) or getattr(websocket.request, 'path', '/')` for both v12 and v16+ compatibility
   - **Result:** `activity_log.jsonl` now created and persisted correctly

6. **Wrong Backend Directory** - Operational fix
   - **Symptom:** Activity panel empty, old code running
   - **Root Cause:** Old uvicorn process from `/mnt/c/Development/Builder-CLI/tmux-builder/backend` was holding ports
   - **Fix:** Killed old process, restarted from correct directory `/mnt/c/Development/Builder-CLI/tmux-builder-ui/tmux-builder/backend`

### Commits Made
```
0bf7067 fix: resolve critical client dashboard bugs and add onboarding flow
9e0289f fix(ws_server): support websockets v12 path API
e04cbb3 docs: update websockets API gotcha for v12 compatibility
```

### Testing Completed
- [x] Backend restarted from correct directory
- [x] Port 8082 bound by new ws_server
- [x] notify.sh successfully sends messages
- [x] activity_log.jsonl created and persisted
- [x] Multiple message types (status, progress, working) all logged

### UI Routes Summary
| Route | Component | Purpose |
|-------|-----------|---------|
| `/` | SplitChatView | Admin dashboard with password protection, session management |
| `/client_input` or `/onboard` | ClientOnboarding | New client intake form |
| `/client?guid=xxx` | ClientApp | Client project dashboard |

## Notes for Next Assistant

- The codebase uses dual-channel architecture - don't conflate HTTP chat with WebSocket progress
- React hooks in this project are tricky - always check dependency arrays for circular updates
- The client UI is separate from admin UI - different routes, different components
- Check `CLAUDE.md` for architecture overview before making changes
- Port 8080 is backend API, port 8082 is WebSocket server - both must be running
- **IMPORTANT:** Verify backend is running from correct directory: `/mnt/c/Development/Builder-CLI/tmux-builder-ui/tmux-builder/backend`
